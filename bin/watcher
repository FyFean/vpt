#!/usr/bin/env node

const fs = require('fs');
const cp = require('child_process');

const path = 'app';
const command = 'make';

let debounced = true;
function watcher() {
    if (debounced) {
        console.log('Running ' + command);
        cp.exec(command);
        debounced = false;
        setTimeout(() => debounced = true, 100);
    }
}

console.log('Setting up watchers ...');

let queue = [path];
while (queue.length > 0) {
    const current = queue.pop();
    fs.watch(current, watcher);
    const stat = fs.lstatSync(current);
    if (stat.isDirectory()) {
        const files = fs.readdirSync(current);
        for (let file of files) {
            queue.push(current + '/' + file);
        }
    }
}

console.log('Done. Watching ...');
